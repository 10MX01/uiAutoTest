## ADDED Requirements

### Requirement: 测试步骤的页面上下文识别

系统必须能够识别每个测试步骤的页面上下文，以确定该步骤是否需要在新的页面上执行。

#### Scenario: 识别导航类步骤

- **WHEN** 分析测试步骤的操作类型
- **THEN** 系统必须识别出导航类操作（如点击链接、提交表单触发跳转、编程式导航）
- **AND** 系统必须将这些步骤标记为需要新页面上下文

#### Scenario: 识别页面内操作

- **WHEN** 分析测试步骤的操作类型
- **THEN** 系统必须识别出页面内操作（如填写表单、点击按钮、展开/折叠元素）
- **AND** 系统必须将这些步骤标记为在当前页面上下文中执行

#### Scenario: 推断步骤的预期页面

- **WHEN** 分析测试步骤的自然语言描述
- **THEN** 系统必须推断该步骤预期在哪个页面上执行
- **AND** 系统必须将推断的页面上下文与步骤关联

### Requirement: 页面变更检测

系统必须检测测试步骤执行后是否发生了页面变化，以触发快照更新。

#### Scenario: 检测URL变化

- **WHEN** 测试步骤执行完成后
- **THEN** 系统必须检测当前URL是否发生变化
- **AND** 如果URL发生变化，系统必须触发新快照的捕获

#### Scenario: 检测路由变化（单页应用）

- **WHEN** 测试步骤在单页应用中执行完成
- **THEN** 系统必须检测路由路径是否发生变化
- **AND** 如果路由发生变化，系统必须将其识别为页面变更

#### Scenario: 检测DOM根元素变化

- **WHEN** 页面URL未变化但DOM结构完全改变时
- **THEN** 系统必须检测根容器元素的变化
- **AND** 如果检测到页面完全替换，系统必须触发新快照捕获

#### Scenario: 区分局部更新和页面变更

- **WHEN** 测试步骤执行后DOM发生局部变化
- **THEN** 系统必须区分局部更新（如弹窗、动态加载内容）和页面级别的变更
- **AND** 系统不得将局部更新误判为需要新快照的页面变更

### Requirement: 步骤-快照关联

系统必须将每个测试步骤与其对应的页面快照关联，以确保选择器生成使用正确的快照。

#### Scenario: 为步骤分配快照上下文

- **WHEN** 解析测试用例的步骤序列
- **THEN** 系统必须为每个步骤分配一个快照上下文标识符
- **AND** 该标识符必须指向该步骤执行时预期的页面快照

#### Scenario: 处理跨页面步骤序列

- **WHEN** 测试用例包含跨页面的步骤序列
- **THEN** 系统必须正确映射每个步骤到其对应的页面快照
- **AND** 步骤N的快照上下文必须反映步骤N-1执行后的页面状态

#### Scenario: 快照上下文传播

- **WHEN** 步骤N导致页面导航
- **THEN** 步骤N+1及其后续步骤必须使用新页面的快照上下文
- **AND** 直到另一个导航操作发生前，所有步骤共享同一快照上下文

### Requirement: AI辅助页面上下文推断

系统必须使用AI模型分析测试步骤描述，以准确推断页面上下文需求。

#### Scenario: 分析自然语言步骤描述

- **WHEN** 接收到测试步骤的自然语言描述
- **THEN** 系统必须使用AI模型分析该描述
- **AND** 系统必须提取指示页面上下文的关键词（如"在管理页面"、"返回首页"）

#### Scenario: 基于历史数据推断

- **WHEN** 步骤描述不足以明确确定页面上下文时
- **THEN** 系统必须参考历史执行数据
- **AND** 系统必须推断最可能的页面上下文

#### Scenario: 处理模糊的步骤描述

- **WHEN** 测试步骤描述模糊且无法确定页面上下文时
- **THEN** 系统必须标记该步骤需要人工确认
- **AND** 系统必须提供可能的页面上下文选项供用户选择